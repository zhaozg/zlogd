name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsqlite3-dev
    
    - name: Setup Zig
      uses: mlugg/setup-zig@v2
      with:
        version: 0.15.1
    
    - name: Build (Debug)
      run: zig build
    
    - name: Run tests
      run: zig build test
    
    - name: Build (ReleaseFast)
      run: zig build -Doptimize=ReleaseFast
    
    - name: Verify executable
      run: ./zig-out/bin/zlogd --help

  integration-test:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsqlite3-dev netcat-openbsd curl jq
    
    - name: Setup Zig
      uses: mlugg/setup-zig@v2
      with:
        version: 0.15.1
    
    - name: Build server
      run: zig build -Doptimize=ReleaseFast
    
    - name: Integration test - Server startup and syslog
      run: |
        # Start server with non-privileged ports
        ./zig-out/bin/zlogd --syslog-port 5514 --rest-port 8080 --snmp-port 1162 &
        SERVER_PID=$!
        
        # Wait for server to start and check if it's listening
        for i in {1..10}; do
          nc -z 127.0.0.1 8080 && echo "Server started successfully" && break
          if [ $i -eq 10 ]; then
            echo "ERROR: Server failed to start"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi
          sleep 1
        done
        
        # Test 1: Send syslog message via UDP
        echo "Testing syslog UDP..."
        echo "<134>Jan 15 12:34:56 testhost testapp[1234]: Integration test message 1" | nc -u -w 1 127.0.0.1 5514
        echo "<134>Jan 15 12:34:57 testhost testapp[1235]: Integration test message 2" | nc -u -w 1 127.0.0.1 5514
        sleep 2
        
        # Test 2: REST API health check
        echo "Testing REST API health endpoint..."
        HEALTH=$(curl -s http://127.0.0.1:8080/health)
        echo "Health response: $HEALTH"
        if ! echo "$HEALTH" | grep -q '"status":"ok"'; then
          echo "ERROR: Health check failed"
          kill $SERVER_PID 2>/dev/null || true
          exit 1
        fi
        
        # Test 3: REST API log submission
        echo "Testing REST API log submission..."
        RESPONSE=$(curl -s -X POST http://127.0.0.1:8080/api/logs \
          -H "Content-Type: application/json" \
          -d '{"message":"REST API test message","level":"info","host":"resthost","app_name":"restapp"}')
        echo "POST response: $RESPONSE"
        if ! echo "$RESPONSE" | grep -q '"status":"created"'; then
          echo "ERROR: Log submission failed"
          kill $SERVER_PID 2>/dev/null || true
          exit 1
        fi
        
        # Test 4: Check log count via REST API
        echo "Testing REST API log retrieval..."
        COUNT=$(curl -s http://127.0.0.1:8080/api/logs)
        echo "Logs count response: $COUNT"
        
        # Cleanup
        echo "Stopping server..."
        kill $SERVER_PID 2>/dev/null || true
        wait $SERVER_PID 2>/dev/null || true
        
        echo "=== Integration tests passed ==="

  benchmark:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsqlite3-dev curl
    
    - name: Setup Zig
      uses: mlugg/setup-zig@v2
      with:
        version: 0.15.1
    
    - name: Build benchmark
      run: zig build bench -Doptimize=ReleaseFast
    
    - name: Run performance benchmark
      run: |
        echo "=== Performance Benchmark Results ==="
        ./zig-out/bin/zlogd-bench
        echo "=== End Benchmark Results ==="
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: benchmark_results.json
        if-no-files-found: ignore
